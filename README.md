# Synthetic-Forecast_Verification
A set of forecast verification routines to evaluate synthetic hydrologic ensemble forecasts against actual forecasts. This repository is aligned with the data generated from two synthetic forecasting approaches that are located in the following GitHub repos:   
    
Synthetic Forecast version 1 [https://github.com/zpb4/Synthetic-Forecast-v1-FIRO-DISES](https://github.com/zpb4/Synthetic-Forecast-v1-FIRO-DISES)   
Synthetic Forecast version 2 [https://github.com/zpb4/Synthetic-Forecast-v2-FIRO-DISES](https://github.com/zpb4/Synthetic-Forecast-v2-FIRO-DISES)   

Data generated from these algorithms for any of the available hindcast locations can be systematically compared via common ensemble verification techniques with the scripts contained in this repository. Importantly, synthetic forecasts should be viewed in the context of their ability to emulate the actual forecast metrics, not in relation to ideal forecast performance. In other words, an ideal synthetic forecast mimics the metric performance of the actual forecasts (HEFS in this case).   

To run these scripts, one must generate synthetic forecast samples from one or both of the referenced algorithms. R scripts in this repository extract data directly from R data structure (.rds) files generated by the main synthetic forecast script that are coded in R. To run the more detailed Python plotting routines, the synthetic and actual HEFS forecasts must be extracted from the R output in netCDF format. Generally speaking, synthetic forecast generations on the order of 10 samples are tractable for processing on a typical personal computing platform (e.g. PC or Mac). Larger samples will require a platform with sufficient RAM (i.e. HPC) to allow manipulation and plotting of the large data arrays. There are some scripts in the workflow that reduce larger samples to a smaller 10 sample chunks for visualization. _To be added: pre-staged data_

## Workflow   
Note: Current date/time indices are setup to be compatible for all current hindcast sites that are available to be generated (ADO, LAM, NHG, YRS). These sites all have different lengths of available observations and HEFS; the date chosen are common across all of them.
### Required pre-run items in synthetic forecast scripts
As noted above, it is required to run the associated synthetic forecast algorithms to generate both HEFS and syn-HEFS forecasts to compare _(until pre-staged data are made available)_. To prepare data for visualization, you must also run the following scripts in the synthetic forecast repos:

-  ./src/slice_plot-ens.R - slices a 10-sample chunk from the full synthetic forecast dataset. You still need to run this, even if generating only 10 samples, to conform with the naming convention of the R verification script
-  ./src/data_writeout_ncdf.R - converts .rds array to netCDF file for extraction via Python routines

### Data extraction and processing
These Python scripts must be run first with the appropriate parameterization inputs to extract and process data for visualization in the Python plotting routines:
- ./src/extract_syn-forecasts.py - extracts synthetic forecast for a specific site from the multisite array in preparation for visualization
- ./src/calc-ecrps.py - calculates the eCRPS metric which is somewhat time consuming. This routine has internal parallelization and can be sped up immensely on an HPC
- ./src/calc-ecrps-cumul.py - as in previous, but for cumulative ensemble statistics
### Plotting
Note: these routines are currently being built out; routines in _italics_ are in the repo but not fully up to date
- ./src/plot_ensembles.R - coarser set of verification visualizations that can be run directly after generation via the R scripts and the 'slice_plot-ens.R' subsetting operation described above
- ./src/forc-ensemble-verification.py - main set of manuscript quality figures that compares the two forecast methods across 3 common metrics; metrics are shown only for VAL years from model fitting
- _./src/forc-ensemble-verification_cumul.py - as above, but for cumulative forecast statistics; currently needs updated to multisite setup_
- _./src/ensemble-plot.py - ensemble plotting routine for manuscript quality figures; needs updated to multisite setup_

### Contact
Zach Brodeur, zpb4@cornell.edu
